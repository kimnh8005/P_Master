FROM openjdk:8-jre

ARG WAR_FILE_PATH
ARG EXPOSE_PORT

ARG WAR_FILE_NAME
ENV WAR_FILE_NAME=${WAR_FILE_NAME}

ARG PROFILE
ENV PROFILE=${PROFILE}

USER root
ENV LANG=ko_KR.UTF-8
EXPOSE ${EXPOSE_PORT}

ENV WHATAP_SOURCE_HOME=${WAR_FILE_PATH}/whatap
ENV WHATAP_TARGET_HOME=/whatap
ENV WHATAP_JAR=whatap.agent-2.0_24.jar
ENV WHATAP_KEY_FILE=paramkey.txt
ENV WHATAP_CONF=whatap.conf
ENV WHATAP_CONF_DEV=whatap-dev.conf
ENV WHATAP_CONF_PROD=whatap-prod.conf
ENV WHATAP_OKIND="-Dwhatap.okind=bos-${PROFILE}"
ENV WHATAP_OPTS="-Dwhatap.name=bos-${PROFILE}-{ip2}-{ip3}"

RUN mkdir -p ${WHATAP_TARGET_HOME}
COPY ${WHATAP_SOURCE_HOME}/${WHATAP_JAR} ${WHATAP_TARGET_HOME}
COPY ${WHATAP_SOURCE_HOME}/${WHATAP_KEY_FILE} ${WHATAP_TARGET_HOME}

COPY ${WHATAP_SOURCE_HOME}/${WHATAP_CONF_DEV} ${WHATAP_TARGET_HOME}
COPY ${WHATAP_SOURCE_HOME}/${WHATAP_CONF_PROD} ${WHATAP_TARGET_HOME}
RUN if [ "${PROFILE}" = "ver" ] || [ "${PROFILE}" = "prod" ]; then \
        mv ${WHATAP_TARGET_HOME}/${WHATAP_CONF_PROD} ${WHATAP_TARGET_HOME}/${WHATAP_CONF}; \
        rm -rf ${WHATAP_TARGET_HOME}/${WHATAP_CONF_DEV}; \
    else \
        mv ${WHATAP_TARGET_HOME}/${WHATAP_CONF_DEV} ${WHATAP_TARGET_HOME}/${WHATAP_CONF}; \
        rm -rf ${WHATAP_TARGET_HOME}/${WHATAP_CONF_PROD}; \
    fi

COPY ${WAR_FILE_PATH}/${WAR_FILE_NAME} /${WAR_FILE_NAME}

ENV HEAP_SIZE="2048m"
ENV JAVA_GC="-XX:+UseParallelOldGC -XX:+DisableExplicitGC"
ENV SPRING_PROFILE="-Dspring.profiles.active=${PROFILE}"
ENV JAVA_OPTS="-server -Dfile.encoding=UTF-8 -Dlog4j2.formatMsgNoLookups=true -Djava.security.egd=file:/dev/./urandom -Xms${HEAP_SIZE} -Xmx${HEAP_SIZE} ${JAVA_GC} ${SPRING_PROFILE}"

ENTRYPOINT java ${JAVA_OPTS} -javaagent:"${WHATAP_TARGET_HOME}"/"${WHATAP_JAR}" "${WHATAP_OKIND}" "${WHATAP_OPTS}" -jar /"${WAR_FILE_NAME}"
