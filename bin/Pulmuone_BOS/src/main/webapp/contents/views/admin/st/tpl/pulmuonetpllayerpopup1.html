<div class="wrap-location">
    <h1 class="title">Pulmuone Layer Popup1</h1>
</div>

<!-- 팝업 레이어1 -->
<div id="layer1" class="fb__layerPopup fb__layerPopup--open">
    <div class="fb__sect">
        <form id="inputForm" class="fb__sect__form inputForm" name="inputForm" method="post"
            enctype="multipart/form-data">
            <!-- 팝업 폼 섹션 1 -->
            <section class="inputForm__section">
                <header class="inputForm__section__header">
                    <h3 class="inputForm__section__title">문의 정보</h3>
                </header>
                <table class="datatable v-type">
                    <colgroup>
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">
                                <label class="req-star-front" for="productClassify">상품분류</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <select class="inputForm__select" name="productClassify" id="productClassify"
                                        required>
                                        <option value="고객상품문의">
                                            고객 상품문의
                                        </option>
                                    </select>
                                </div>
                            </td>
                            <th scope="row">
                                <label for="dataClassify">데이터분류</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="dataClassify" name="dataClassify"
                                        class="comm-input input-readonly" readonly />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="seller" class="req-star-front">셀러</label>
                            </th>
                            <td colspan="3">
                                <div class="complex-condition">
                                    <input type="text" id="seller" name="seller" class="comm-input" style="width: 202px"
                                        required disabled />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="productName">상품명</label>
                            </th>
                            <td colspan="3">
                                <div class="complex-condition">
                                    <input type="text" id="productName""
                                    name=" productName"" class="comm-input
                                    disabled" style="width:202px" required disabled />
                                    <div class="inputForm__button-wrapper">
                                        <button type="button" class="fb-btn btn-gray inputForm__button"
                                            id="showGoodsBtn">
                                            제품보기
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- 팝업 폼 섹션 2 -->
            <section class="inputForm__section">
                <header class="inputForm__section__header">
                    <h3 class="inputForm__section__title">문의자 정보</h3>
                </header>
                <table class="datatable v-type">
                    <colgroup>
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">
                                <label class="req-star-front" for="userName">이름</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="userName" name="userName" class="comm-input" required
                                        disabled />
                                </div>
                            </td>
                            <th scope="row">
                                <label for="createdDate">작성일</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="createdDate" name="createdDate"
                                        class="comm-input input-readonly" readonly />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label class="req-star-front" for="phoneNum">휴대폰번호</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="phoneNum" name="phoneNum" class="comm-input" required
                                        disabled />
                                </div>
                            </td>
                            <th scope="row">
                                <label for="userMail" class="req-star-front">이메일</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="userMail" name="userMail" class="comm-input" required
                                        disabled />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <span class="req-star-front">비밀여부</span>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <div class="checkbox-wrapper">
                                        <!-- 체크 박스 영역 -->
                                        <label>
                                            <input type="radio" name="isSecret" value="Y" />
                                            <span>예</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="isSecret" value="N" checked />
                                            <span>아니오</span>
                                        </label>
                                    </div>
                                </div>
                            </td>
                            <th scope="row">
                                <label for="userId" class="req-star-front">ID</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <input type="text" id="userId" name="userId" class="comm-input" required disabled />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="userTitle" class="req-star-front">제목</label>
                            </th>
                            <td colspan="3">
                                <div class="complex-condition">
                                    <input type="text" id="userTitle" name="userTitle" class="comm-input"
                                        style="width: 100%" required disabled />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <div class="complex-condition">
                                    <textarea name="userContent" id="userContent" class="inputForm__textarea pdf-page"
                                        cols="30" rows="10" style="width: 100%" required disabled></textarea>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <span for="productName">첨부파일</span>
                            </th>
                            <td colspan="3">
                                <div class="complex-condition">
                                    <button id="addFileBtn" class="fb-btn inputForm__fileBtn" type="button">
                                        파일첨부
                                    </button>
                                    <input type="file" name="fileInputBtn" id="fileInputBtn" style="display: none" />
                                    <input type="hidden" name="userFile" id="userFile" />
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- 팝업 폼 섹션 3 -->
            <section class="inputForm__section">
                <header class="inputForm__section__header">
                    <h3 class="inputForm__section__title">답변 정보</h3>
                </header>
                <table class="datatable v-type">
                    <colgroup>
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                        <col style="width: 20%" />
                        <col style="width: 30%" />
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">
                                <label class="req-star-front" for="answerTemplate">답변템플릿</label>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <!-- 답변 템플릿 셀렉트 박스 영역 -->
                                    <select name="answerTemplate" id="answerTemplate"
                                        class="inputForm__select select-box" style="width: 100%" required></select>
                                </div>
                            </td>
                            <th scope="row">
                                <span class="req-star-front">처리상태</span>
                            </th>
                            <td>
                                <div class="complex-condition">
                                    <div class="radios-wrapper">
                                        <!-- 라디오 박스 영역 -->
                                        <label>
                                            <input type="radio" name="dealStatus" value="dealingRegister"
                                                checked="checked" />btn-point
                                            <span>접수</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="dealStatus" value="dealing" />
                                            <span>처리중</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="dealStatus" value="dealingComplete" />
                                            <span>처리완료</span>
                                        </label>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <div class="complex-condition">
                                    <label for="answerContent" style="visibility: hidden">답변내용</label>
                                    <textarea class="inputForm__textarea" name="answerContent" id="answerContent"
                                        cols="30" rows="10"></textarea>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <span class="btn-area">
                <button type="submit" id="fnSave" class="btn-type-blue">
                    저장
                </button>
                <button type="button" id="fnRemove" class="btn-type-gray">
                    삭제
                </button>
                <button type="button" id="fnClose" class="btn-type-white">
                    닫기
                </button>
            </span>
            <!-- 로딩 영역 -->
            <div class="loading">
                <div class="loading__image">loading...</div>
            </div>
        </form>
    </div>
</div>
<!-- 팝업 레이어1 End -->

<!-- 팝업 레이어2 -->
<!-- 팝업 레이어2 End -->

<!-- 팝업 레이어 3 -->
<!-- 팝업 레이어 3 End -->

<script>
    // Import DejaVu Sans font for embedding

    // NOTE: Only required if the Kendo UI stylesheets are loaded
    // from a different origin, e.g. cdn.kendostatic.com
    kendo.pdf.defineFont({
        "Noto Sans": "/contents/fonts/NotoSans.ttf",
        "Noto Sans|Light": "/contents/fonts/NotoSans-Light.ttf",
        "Noto Sans|Bold": "/contents/fonts/NotoSans-Bold.ttf",
        "Noto Sans|Italic": "/contents/fonts/NotoSans-Italic.ttf",
        "WebComponentsIcons": "https://kendo.cdn.telerik.com/2017.1.223/styles/fonts/glyphs/WebComponentsIcons.ttf"
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.2/pako.min.js"
    integrity="sha512-IjkvjWp4tSkhkQRb9gFwCcMhBWZLPKc7Zo8ifb6qxORyehV072QgRVG3F0fwAaJh0fnEFNLc2+XggoC5wvW24g=="
    crossorigin="anonymous"></script>
<script type="text/javascript">
    function getPDF(selector) {
        kendo.drawing.drawDOM($(selector)).then(function (group) {
            kendo.drawing.pdf.saveAs(group, "Invoice.pdf");
        });
    }


    const listTemplate = function listTemplate() {
        // template elements
        const $document = $(document);
        const $form = $("#inputForm");

        // 노출 타입 라디오 버튼
        const $showType = $("input[name='showType']");

        //상품 분류
        const $productClassify = $("#productClassify");

        //데이터 분류
        const $dataClassify = $("#dataClassify");

        //셀러
        const $seller = $("#seller");

        //상품명
        const $productName = $("#productName");

        //제품 보기 버튼
        const $showGoodsBtn = $("#showGoodsBtn");

        //이름
        const $userName = $("#userName");

        //작성일
        const $createdDate = $("#createdDate");

        //휴대폰 번호
        const $phoneNum = $("#phoneNum");

        //이메일
        const $userMail = $("#userMail");

        //비밀 여부
        const $isSecret = $("input[name='isSecret']");

        //아이디
        const $userId = $("#userId");

        //제목
        const $userTitle = $("#userTitle");

        //제목
        const $userContent = $("#userContent");

        //파일 첨부 버튼
        const $addFileBtn = $("#addFileBtn");

        const $fileInputBtn = $("#fileInputBtn");

        //파일 input hidden
        const $userFile = $("#userFile");

        //처리 상태
        const $dealStatus = $("input[name='dealStatus']");

        //답변 상태
        const $answerTemplate = $("#answerTemplate");

        //답변 내용
        const $answerContent = $("#answerContent");

        // 폼 버튼
        const $saveBtn = $("#fnSave");
        const $removeBtn = $("#fnRemove");
        const $closeBtn = $("#fnClose");

        const sampleData = {
            answerContent: "답변 내용",
            answerTemplate: [
                {
                    ctgryStdNm: "답변1",
                    ilCtgryStdId: "131670",
                },
                {
                    ctgryStdNm: "답변2",
                    ilCtgryStdId: "131671",
                },
            ],
            createdDate: "2020-12-12",
            dataClassify: "dataClassify",
            dealStatus: "dealingComplete",
            isSecret: "Y",
            phoneNum: "010-123-1234",
            productClassify: [
                {
                    ctgryStdNm: "고객 상품문의",
                    ilCtgryStdId: "131670",
                },
                {
                    ctgryStdNm: "고객 상품문의2",
                    ilCtgryStdId: "131671",
                },
            ],
            productName: "productName",
            seller: "seller",
            userContent: "userContent",
            userFile: "userFile",
            userId: "userId",
            userMail: "userMail",
            userName: "userName",
            userTitle: "userTitle",
        };

        //data
        const fbData = {
            //로딩
            fetches: {
                search: false,
            },

            //api요청 파라미터
            requests: {
                apiId: "",
                formData: null,
                productClassify: "sampleId",
            },

            //데이터
            data: {
                productClassify: [],
                dummyData: {},
            },
        };

        /************************** Functions *******************************/
        /**
         * 	유효성검사
         *  data-validator-required 필수값 여부 html 엘리먼트에 추가
         *  data-validator-reg 정규식 여부 필요한 경우 html 엘리먼트에 추가 없으면 빈 값만 체크
         */
        function validator(requestObj) {
            let result = true;
            for (let [key, value] of Object.entries(requestObj)) {
                const $target = $("[name=" + key + "]");
                let isRequired = $target.attr("data-validator-required");

                if (isRequired) {
                    if (value == "") {
                        result = false;
                    } else {
                        let isReg = $target.attr("data-validator-reg");
                        let makeReg = new RegExp(isReg, "g");

                        if (isReg && !makeReg.test(value)) {
                            result = false;
                        }
                    }
                }
            }
            return result;
        }

        // api 검색 요청
        function requestSearch(parameter) {
            let isLoading = fbData.fetches.search;
            isLoading = true;
            loading(isLoading);

            try {
                console.log(parameter);
                //api연동
                setTimeout(function () {
                    isLoading = false;
                    loading(isLoading);
                }, 1000);
            } catch (ex) {
                console.log("requestSearch has exception...", ex);
            }
        }

        //초기 데이터 요청
        function requestCateData(selector) {
            // 데이터 요청  > 데이터 렌더링

            if (!selector) return;

            const $target = $("#" + selector);

            try {
                const parameter = fbData.requests[selector];
                //api요청
                //temp api response
                let response = [
                    {
                        ctgryStdNm: "고객 상품문의",
                        ilCtgryStdId: "131670",
                    },
                    {
                        ctgryStdNm: "고객 상품문의2",
                        ilCtgryStdId: "131671",
                    },
                ];

                if (response) {
                    fbData.data[selector] = response;
                    $target.empty();

                    // 상품 분류 해당 _depth 렌더링
                    response.forEach(function (d) {
                        const $option = `<option value="${d.ilCtgryStdId}">${d.ctgryStdNm}</option>`;
                        $target.append($option);
                    });
                }
            } catch (ex) {
                console.log("requestCateData has exception...", ex);
            }
        }

        //로딩바
        function loading(_value) {
            const _display = _value ? "block" : "none";

            $(".loading").css("display", _display);
        }

        // form data 생성 함수
        function makeFormData($form) {
            const requestObj = {};
            const formData = $form.serialize().split("&");

            // 모든 입력 값 데이터객체화
            formData.forEach(function (d) {
                const reg = d.split(/\=/);

                if (reg) {
                    const key = reg[0];
                    const value = reg[1];

                    //한글이거나 특수문자의 경우 decode
                    requestObj[key] = decodeURIComponent(value);
                }
            });

            const isPass = validator(requestObj);

            if (isPass) {
                //검색 API연동
                return requestObj;
            } else {
                console.log("requestObj : ", requestObj);
                alert("필수값을 확인해주세요.");
                return null;
            }
        }

        // 데이터 요청 함수
        function fetchData() {
            loading(true);
            try {
                const parameter = fbData.requests.apiId;

                const response = sampleData;

                if (response && typeof response === "object") {
                    // 샘플 데이터 ajax처리
                    fbData.data.dummyData = response;
                    bindForm($form, response);
                    setTimeout(function () {
                        loading(false);
                    }, 1000);
                }
            } catch (ex) {
                console.log("fetchData has exception...", ex);
            }
        }

        // 폼 바인딩 함수
        function bindForm($form, data) {
            if (!data) return;

            $form
                .find("input, textarea, select, radio, checkbox")
                .each(function () {
                    const $this = $(this);
                    const _name = $this.attr("name");

                    if ($this.is("textarea")) {
                        $this.val(data[_name]);
                    }

                    if ($this.is("select")) {
                        renderSelectBox($this, data[_name]);
                    }

                    if ($this.is("input")) {
                        switch ($this.attr("type")) {
                            case "text":
                            case "email":
                            case "password":
                            case "hidden":
                                $this.val(data[_name]);
                                break;
                            case "radio":
                                if ($this.val() == data[_name]) {
                                    $this.prop("checked", true);
                                }
                                break;
                            case "checkbox":
                                break;
                            case "file":
                                break;
                            default:
                                break;
                        }
                    }
                });
        }

        function renderSelectBox($el, data) {
            $el.empty();

            // 상품 분류 해당 _depth 렌더링
            data.forEach(function (d) {
                const $option = `<option value="${d.ilCtgryStdId}">${d.ctgryStdNm}</option>`;
                $el.append($option);
            });
        }

        /*****************************************************************/

        /************************** 이벤트 핸들러*******************************/
        function onSubmit(e) {
            e.preventDefault();
            const $this = $(this);
            const requestObj = fbMakeFormData($this);
            console.log(requestObj);
            if (requestObj) {
                requestSearch(requestObj);
            } else {
                return;
            }
        }

        //파일 첨부 버튼 클릭 이벤트
        function onClickAddFileBtn() {
            $fileInputBtn.trigger("click");
        }

        //file reader
        const readURL = function (input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    console.log(e);

                    //userFile의 value에 파일의 url을 넣어준다
                    $userFile.val(e.target.result);
                    input.value = "";
                };

                reader.readAsDataURL(input.files[0]); // convert to base64 string
            }
        };

        //제품 보기 버튼
        function onClickShowButton(e) {
            console.log(e);
        }

        //삭제 버튼 이벤트
        function onRemove(e) {
            console.log(e);
        }

        //닫기 버튼 이벤트
        function onClose(e) {
            console.log(e);
        }

        function popupShow() {
            $document.on("click", ".popupBtn", function () {
                const $this = $(this);
                const $target = $("#" + $this.data("content"));

                $target.show();

            })
        }


        // .k-grid td.k-state-focused
        //init 함수
        function init() {
            fetchData();

            popupShow();

            // 제품 보기 버튼 이벤트
            $showGoodsBtn.on("click", onClickShowButton);

            //삭제 버튼 이벤트
            $removeBtn.on("click", onRemove);

            //닫기 버튼 이벤트
            $closeBtn.on("click", onClose);

            // 폼 submit 버튼 이벤트
            $form.on("submit", onSubmit);

            //파일 첨부 버튼 클릭 이벤트
            $addFileBtn.on("click", onClickAddFileBtn);

            //파일 첨부시 발생하는 이벤트
            $fileInputBtn.on("change", function (e) {
                readURL(this);
            });
        }

        init();
    };

    listTemplate();

    fnKendoEditor({ id: "answerContent" });

    // 폼 데이터 시이얼라이즈 함수
    function fbMakeFormData($form) {
        if (!$form) return;

        const result = {};

        $form
            .find("input, textarea, select, radio, checkbox")
            .each(function () {
                const $this = $(this);
                const _name = $this.attr("name");

                if ($this.is("textarea")) {
                    result[_name] = $this.val().trim();
                }

                if ($this.is("select")) {
                    result[_name] = $this.val();
                }

                if ($this.is("input")) {
                    switch ($this.attr("type")) {
                        case "text":
                        case "email":
                        case "password":
                        case "hidden":
                            result[_name] = $this.val();
                            break;
                        case "radio":
                            //라디오 버튼이 체크되어 있을 경우
                            if ($this.is(":checked")) {
                                result[_name] = $this.val();
                            }
                            break;
                        case "checkbox":
                            //라디오 버튼이 체크되어 있을 경우
                            if ($this.is(":checked")) {
                                //result안에 해당 프로퍼티가 존재하고, 배열일 경우에만 값을 push
                                if (
                                    result[_name] &&
                                    Array.isArray(result[_name])
                                ) {
                                    result[_name].push($this.val());
                                } else {
                                    result[_name] = [];
                                    result[_name].push($this.val());
                                }
                            }
                            break;
                        case "file":
                            break;
                        default:
                            break;
                    }
                }
            });
        return result;
    }
</script>