<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.pulmuone.v1.comm.mappers.batch.master.goods.stock.BatchItemErpStockReCalQtyMapper">

    <!--───────────────────────────────────────────────────────────────────────
     * description   : 품목 연동재고 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2020.12.15  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getErpStockOrgList" resultType="kr.co.pulmuone.v1.comm.api.dto.basic.ErpStockReCalQtyResponseDto">
    /* itemErpStockReCalQty.getErpStockOrgList */
    SELECT A.IL_ITEM_ERP_STOCK_ID /* 품목연동재고ID */
          ,A.IL_ITEM_WAREHOUSE_ID /* 품목별 출고처ID */
	      ,A.BASE_DT              /* 기준일 */
	      ,A.STOCK_QTY            /* 재고 */
	      ,B.IL_ITEM_CD           /* 품목코드 */
	      ,IFNULL(C.DISTRIBUTION_PERIOD, 0) AS DISTRIBUTION_PERIOD /* 품목 유통기간 */
	 FROM IL_ITEM_ERP_STOCK A
	INNER JOIN IL_ITEM_WAREHOUSE B
	        ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	       AND A.STOCK_TP = 'ERP_STOCK_TP.CLOSED'          /* 재고타입-전일마감재고 */
	       AND A.BASE_DT  = STR_TO_DATE(NOW(), '%Y-%m-%d')/* 기준일-현재일기준 */
	INNER JOIN IL_ITEM C
	        ON B.IL_ITEM_CD = C.IL_ITEM_CD
    </select>


    <!--───────────────────────────────────────────────────────────────────────
     * description   : 품목 유통기한별 재고 합계 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2020.12.15  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getStockExprSum" resultType="int">
    /* itemErpStockReCalQty.getStockExprSum */
    SELECT IFNULL(SUM(A.STOCK_QTY),0) AS SUM_QTY /* 재고합계 */
	  FROM IL_ITEM_STOCK_EXPR A
	 INNER JOIN IL_ITEM_WAREHOUSE B
	         ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	        AND A.BASE_DT = #{baseDt} /* 기준일 */
	        AND A.IL_ITEM_WAREHOUSE_ID = #{ilItemWarehouseId} /* 품목별 출고처ID */
    </select>

    <!--───────────────────────────────────────────────────────────────────────
     * description   : 유통기한이 지난 품목 유통기한별 재고 합계 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2021.01.19  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getStockExprExcessSum" resultType="Integer">
    /* itemErpStockReCalQty.getStockExprExcessSum */
    SELECT SUM(A.STOCK_QTY) AS SUM_QTY /* 재고합계 */
	  FROM IL_ITEM_STOCK_EXPR A
	 INNER JOIN IL_ITEM_WAREHOUSE B
	         ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	        AND A.BASE_DT = #{baseDt} /* 기준일 */
	        AND A.EXPIRATION_DT <![CDATA[ < ]]> #{baseDt} /* 기준일  보다 작은 유통기한 */
	        AND A.IL_ITEM_WAREHOUSE_ID = #{ilItemWarehouseId} /* 품목별 출고처ID */
    </select>


    <!--───────────────────────────────────────────────────────────────────────
     * description : 품목 유통기한별 재고 ID 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2020.12.15  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getStockExprSearch" resultType="kr.co.pulmuone.v1.batch.goods.stock.dto.vo.ItemErpStockReCalQtyResultVo">
    /* itemErpStockReCalQty.getStockExprSearch */
    SELECT A.IL_ITEM_STOCK_EXPR_ID /* 품목 유통기한별 재고ID */
          ,A.STOCK_QTY             /* 재고수량 */
	  FROM IL_ITEM_STOCK_EXPR A
	 INNER JOIN IL_ITEM_WAREHOUSE B
	         ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	        AND A.BASE_DT = #{baseDt} /* 기준일 */
	        AND A.IL_ITEM_WAREHOUSE_ID = #{ilItemWarehouseId} /* 품목별 출고처ID */
	      ORDER BY A.EXPIRATION_DT DESC LIMIT 1
    </select>


    <!--───────────────────────────────────────────────────────────────────────
     * description : 품목 유통기한별 재고 목록 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2020.12.15  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getStockExprSearchList" resultType="kr.co.pulmuone.v1.batch.goods.stock.dto.vo.ItemErpStockReCalQtyResultVo">
    /* itemErpStockReCalQty.getStockExprSearchList */
    SELECT A.IL_ITEM_STOCK_EXPR_ID /* 품목 유통기한별 재고ID */
          ,A.STOCK_QTY             /* 재고수량 */
	  FROM IL_ITEM_STOCK_EXPR A
	 INNER JOIN IL_ITEM_WAREHOUSE B
	         ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	        AND A.BASE_DT = #{baseDt} /* 기준일 */
	        AND A.IL_ITEM_WAREHOUSE_ID = #{ilItemWarehouseId} /* 품목별 출고처ID */
	      ORDER BY A.EXPIRATION_DT DESC
    </select>


    <!--───────────────────────────────────────────────────────────────────────
     * description : 품목 유통기한별 재고 수량 수정
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2020.12.15  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <update id="putStockExprTotalSum">
    /* itemErpStockReCalQty.putStockExprTotalSum */
    UPDATE IL_ITEM_STOCK_EXPR
       SET STOCK_QTY = #{stockQty, javaType=INT, jdbcType=INTEGER} /* 재고수량 */
     WHERE IL_ITEM_STOCK_EXPR_ID = #{ilItemStockExprId, javaType=LONG, jdbcType=INTEGER} /* 품목 유통기한별 재고ID */
    </update>


     <!--───────────────────────────────────────────────────────────────────────
     * description : 유통기한이 지난 품목 유통기한별 재고합계로 수정
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2021.1.19  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <update id="putItemErpStock">
    /* itemErpStockReCalQty.putItemErpStock */
	UPDATE IL_ITEM_ERP_STOCK
	   SET STOCK_QTY = #{stockQty, javaType=INT, jdbcType=INTEGER} /* 재고수량 */
	 WHERE IL_ITEM_ERP_STOCK_ID = #{ilItemErpStockId, javaType=long, jdbcType=INTEGER} /* 품목 연동재고ID */
    </update>

     <!--───────────────────────────────────────────────────────────────────────
     * description : 유통기한이 지난 품목 유통기한별 재고합계로 이력수정
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2021.2.10  이성준         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <update id="putItemErpStockHistory">
	/* itemErpStockReCalQty.putItemErpStockHistory */
	 UPDATE IL_ITEM_ERP_STOCK_HISTORY
	    SET STOCK_QTY = #{stockQty, javaType=INT, jdbcType=INTEGER} /* 재고수량 */
	  WHERE IL_ITEM_ERP_STOCK_ID = #{ilItemErpStockId, javaType=long, jdbcType=INTEGER} /* 품목 연동재고ID */
    </update>


   <!--───────────────────────────────────────────────────────────────────────
     * description   : 품목 유통기한별 재고 저장
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2021.01.18  원종한         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <insert id="addItemStockExpr">
    /* itemErpStockReCalQty.addItemStockExpr */
    INSERT INTO IL_ITEM_STOCK_EXPR
        (
          IL_ITEM_WAREHOUSE_ID
        , BASE_DT
        , EXPIRATION_DT
        , STOCK_QTY
        , STOCK_TP
        , CREATE_ID
        , CREATE_DT
        )
        VALUES
        (
          #{ilItemWarehouseId}
        , #{baseDt}
        , #{expirationDt}
        , #{stockQty}
        , #{stockTp}
        , 0
        , NOW()
        )

    </insert>

    <!--───────────────────────────────────────────────────────────────────────
     * description : 품목 유통기한별 재고 ID 조회 - 유통기한 날짜로 조회
     * @
     * @ 수정일                 수정자          수정내용
     * @ ──────────────────────────────────────────────────────────────────────
     * @ 2021.01.18  원종한         최초생성
    ────────────────────────────────────────────────────────────────────────-->
    <select id="getStockExprSearchByExpirationDate" resultType="kr.co.pulmuone.v1.batch.goods.stock.dto.vo.ItemErpStockReCalQtyResultVo">
    /* itemErpStockReCalQty.getStockExprSearchByExpirationDate */
    SELECT A.IL_ITEM_STOCK_EXPR_ID /* 품목 유통기한별 재고ID */
          ,A.STOCK_QTY             /* 재고수량 */
	  FROM IL_ITEM_STOCK_EXPR A
	 INNER JOIN IL_ITEM_WAREHOUSE B
	         ON A.IL_ITEM_WAREHOUSE_ID = B.IL_ITEM_WAREHOUSE_ID
	        AND A.BASE_DT = #{baseDt} /* 기준일 */
	        AND A.IL_ITEM_WAREHOUSE_ID = #{ilItemWarehouseId} /* 품목별 출고처ID */
	        AND A.EXPIRATION_DT = #{expirationDt} /* 유통기한 */
	 LIMIT 1
    </select>

</mapper>
