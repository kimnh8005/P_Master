<?xml version="1.0" encoding="UTF-8"?>
		<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.pulmuone.v1.comm.mapper.order.schedule.OrderDetailScheduleMapper">

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문 스케줄 리스트 Request 정보 조회(주문번호, 주문상세  상품 PK, 일일상품 유형)
	 * @
	 * @ 수정일			수정자          수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.01.29 	이규한          최초생성
	 * @
	────────────────────────────────────────────────────────────────────────-->
	<resultMap id="getOrderScheduleRequestInfoResultMap" type="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleListRequestDto">
		<result column="OD_ORDER_DETL_ID"			property="odOrderDetlId"/>
		<result column="OD_ORDER_ID"	property="odOrderId"/>
		<result column="ODID"			property="odid"/>
		<result column="IL_GOODS_ID"			property="ilGoodsId"/>
		<result column="ORG_IL_GOODS_ID"			property="orgIlGoodsId"/>
		<result column="GOODS_DAILY_TP"			property="goodsDailyTp"/>
		<result column="RECV_ZIP_CD"			property="recvZipCd"/>
		<result column="RECV_BLD_NO"			property="recvBldNo"/>
		<result column="UR_WAREHOUSE_ID"			property="urWarehouseId"/>
		<result column="PROMOTION_YN"			property="promotionYn"/>
		<result column="OD_ORDER_DETL_SEQ"			property="odOrderDetlSeq"/>
		<result column="CUTOFF_TIME_YN"			property="cutoffTimeYn"/>
		<result column="LAST_DELIVERY_DT"			property="lastDeliveryDt"/>
		<result column="GOODS_CYCLE_TERM_TP"		property="goodsCycleTermTp"/>
	</resultMap>

	<select id="getOrderScheduleRequestInfo" resultMap="getOrderScheduleRequestInfoResultMap">
		/* orderDetailSchedule.getOrderScheduleRequestInfo */
		SELECT OOD.OD_ORDER_DETL_ID 	/* 주문상세 PK */
		     , OOD.OD_ORDER_ID 			/* 주문 PK */
		     , OO.ODID					/* 주문번호 */
			   /* UDMD I/F 하는 상품인 경우, PDM_GROUP_CD로 상품정보 조회, 그외 상품ID로 조회 */
     		 , CASE WHEN OOD.GOODS_DAILY_TP = 'GOODS_DAILY_TP.BABYMEAL' OR OOD.GOODS_DAILY_TP = 'GOODS_DAILY_TP.EATSSLIM'
            		THEN (SELECT IFNULL(II.PDM_GROUP_CD, II.IL_ITEM_CD)
                    		FROM IL_ITEM II
                   		   WHERE OOD.IL_ITEM_CD = II.IL_ITEM_CD
                  		 )
            		ELSE OOD.IL_GOODS_ID
            		END AS IL_GOODS_ID	/* I/F 상품ID */
             , OOD.IL_GOODS_ID 	 		AS ORG_IL_GOODS_ID	/* 주문상세 상품ID */
		     , OOD.GOODS_DAILY_TP		/* 일일상품 유형(GOODS_DAILY_TP : GREENJUICE/BABYMEAL/EATSSLIM ) */
		     , FN_DECRYPT(OSZ.RECV_ZIP_CD) 	AS RECV_ZIP_CD	/* 수령인 우편번호 */
		     , OSZ.RECV_BLD_NO 			/* 건물번호 */
		     , OOD.UR_WAREHOUSE_ID
		     , (CASE WHEN OOD.PROMOTION_TP = 'CART_PROMOTION_TP.GREENJUICE_SELECT' THEN 'Y' ELSE 'N' END) AS PROMOTION_YN
		     , OOD.OD_ORDER_DETL_SEQ
			 , CASE
			  	WHEN NOW() <![CDATA[ < ]]> CONCAT(DATE_FORMAT(NOW(),'%Y-%m-%d'), ' ', UW.CUTOFF_TIME) THEN 'N'
				ELSE 'Y'
			   END AS CUTOFF_TIME_YN
			 , (SELECT DATE_ADD(MAX(DELIVERY_DT),INTERVAL +1 DAY) FROM OD_ORDER_DETL_DAILY_SCH WHERE OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID AND ORDER_SCH_STATUS = 1 AND USE_YN ='Y') AS LAST_DELIVERY_DT /* 마지막 배송일자(ORDER_SCH_STATUS = 1(주문))  */
			 , OODD.GOODS_CYCLE_TERM_TP
		  FROM OD_ORDER_DETL OOD
		 INNER JOIN OD_ORDER OO
		         ON OOD.OD_ORDER_ID = OO.OD_ORDER_ID
		 INNER JOIN OD_SHIPPING_ZONE OSZ
		         ON OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
		 INNER JOIN UR_WAREHOUSE UW
		 		 ON OOD.UR_WAREHOUSE_ID = UW.UR_WAREHOUSE_ID
		 INNER JOIN OD_ORDER_DETL_DAILY OODD
		     	 ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		 WHERE OOD.OD_ORDER_DETL_ID = #{odOrderDetlId}
	</select>

	<!-- 주문상세 스캐줄 상단정보 resultMap -->
	<resultMap id="getOrderScheduleGoodsInfoResultMap" type="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleGoodsDto">
		<result column="GOODS_NM"			property="goodsNm"/>
		<result column="IL_GOODS_ID"		property="ilGoodsId"/>
		<result column="LAST_DELIVERY_DATE"	property="lastDeliveryDate"/>
		<result column="SALE_SEQ"			property="saleSeq"/>
		<result column="MON_CNT"			property="monCnt"/>
		<result column="TUE_CNT"			property="tueCnt"/>
		<result column="WED_CNT"			property="wedCnt"/>
		<result column="THU_CNT"			property="thuCnt"/>
		<result column="FRI_CNT"			property="friCnt"/>
		<result column="ALLERGY_YN"			property="allergyYn"/>
		<result column="OD_ORDER_DETL_ID"	property="odOrderDetlId"/>
		<result column="GOODS_DAILY_TP"		property="goodsDailyTp"/>
		<result column="GOODS_IMG_NM"		property="goodsImgNm"/>
		<result column="PROMOTION_YN"		property="promotionYn"/>
		<result column="RECV_ZIP_CD"		property="recvZipCd"/>
		<result column="RECV_BLD_NO"		property="recvBldNo"/>
		<result column="GOODS_DAILY_TP"		property="goodsDailyTp"/>
		<result column="UR_WAREHOUSE_ID"	property="urWarehouseId"/>
		<result column="ORDER_CNT"			property="orderCnt"/>
		<result column="OD_ORDER_ID"		property="odOrderId"/>
		<result column="ODID"				property="odid"/>
		<result column="ORDER_STATUS_CD"	property="orderStatusCd"/>
		<result column="DAILY_PATTERN"		property="dailyPattern"/>
	</resultMap>

	<select id="getOrderScheduleGoodsInfo" resultMap="getOrderScheduleGoodsInfoResultMap">
		/*	orderDetailSchedule.getOrderScheduleGoodsInfo  */
		SELECT OOD.GOODS_NM
			, OOD.IL_GOODS_ID
			, MAX(DATE_FORMAT(OODDS.DELIVERY_DT,'%Y-%m-%d')) AS LAST_DELIVERY_DATE
			, SUM(CASE WHEN OODDS.DELIVERY_YN='N' THEN OODDS.ORDER_CNT END) AS SALE_SEQ
			, OODD.MON_CNT
			, OODD.TUE_CNT
			, OODD.WED_CNT
			, OODD.THU_CNT
			, OODD.FRI_CNT
			, IFNULL(OODD.ALLERGY_YN, 'N') AS ALLERGY_YN
			, OOD.OD_ORDER_DETL_ID
			, OOD.GOODS_DAILY_TP
			, (CASE WHEN OOD.PROMOTION_TP = 'CART_PROMOTION_TP.GREENJUICE_SELECT' THEN 'Y' ELSE 'N' END) AS PROMOTION_YN
			, FN_DECRYPT(OSZ.RECV_ZIP_CD) 	AS RECV_ZIP_CD	/* 수령인 우편번호 */
		    , OSZ.RECV_BLD_NO 			/* 건물번호 */
		    , OOD.GOODS_DAILY_TP
		    , OOD.UR_WAREHOUSE_ID
		    , OODD.ORDER_CNT
		    , OOD.OD_ORDER_ID
		    , OOD.ODID
			, OOD.ORDER_STATUS_CD
		    , OODD.DAILY_PATTERN
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
				)
		) OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
		INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		INNER JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
		WHERE OODDS.USE_YN = 'Y'
		GROUP BY OODDS.OD_ORDER_DETL_DAILY_ID
	</select>

	<select id="getOrderScheduleSelectGoodsInfo" resultMap="getOrderScheduleGoodsInfoResultMap">
		/*	orderDetailSchedule.getOrderScheduleSelectGoodsInfo  */
		SELECT OODP.GOODS_NM
			, FN_GOODS_C_IMG(OODP.IL_GOODS_ID) AS GOODS_IMG_NM
			, MIN(DATE_FORMAT(OODDS.DELIVERY_DT,'%Y-%m-%d')) AS FIRST_DELIVERY_DATE
			, MAX(DATE_FORMAT(OODDS.DELIVERY_DT,'%Y-%m-%d')) AS LAST_DELIVERY_DATE
			, SUM(CASE WHEN OODDS.DELIVERY_YN='N' THEN OODDS.ORDER_CNT END) AS SALE_SEQ
			, SUM(OODD.MON_CNT) AS MON_CNT
			, SUM(OODD.TUE_CNT) AS TUE_CNT
			, SUM(OODD.WED_CNT) AS WED_CNT
			, SUM(OODD.THU_CNT) AS THU_CNT
			, SUM(OODD.FRI_CNT) AS FRI_CNT
			, (CASE WHEN OODP.PROMOTION_TP = 'CART_PROMOTION_TP.GREENJUICE_SELECT' THEN 'Y' ELSE 'N' END) AS PROMOTION_YN
			, OODP.GOODS_TP_CD
		FROM
			OD_ORDER_DETL_DAILY_SCH OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID AND OODD.OD_ORDER_ID = #{odOrderId}
		INNER JOIN OD_ORDER_DETL_PACK OODP ON OODD.OD_ORDER_ID = OODP.OD_ORDER_ID
		WHERE OODDS.USE_YN = 'Y'
	</select>

	<select id="getOrderScheduleGoodsBaseInfo" resultMap="getOrderScheduleGoodsInfoResultMap">
		/*	orderDetailSchedule.getOrderScheduleGoodsBaseInfo  */
		SELECT OOD.GOODS_NM
			 , OODD.MON_CNT
			 , OODD.TUE_CNT
			 , OODD.WED_CNT
			 , OODD.THU_CNT
			 , OODD.FRI_CNT
			 , IFNULL(OODD.ALLERGY_YN, 'N') AS ALLERGY_YN
			 , OOD.IL_GOODS_ID
			 , FN_GOODS_C_IMG(OOD.IL_GOODS_ID) AS GOODS_IMG_NM
			 , FN_DECRYPT(OSZ.RECV_ZIP_CD) 	AS RECV_ZIP_CD	/* 수령인 우편번호 */
		     , OSZ.RECV_BLD_NO 			/* 건물번호 */
		     , OOD.GOODS_DAILY_TP
		  FROM OD_ORDER_DETL_DAILY OODD
		 INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		 INNER JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
		 WHERE OODD.OD_ORDER_DETL_ID = #{odOrderDetlId}
	</select>

	<!-- 주문상세 스캐줄 리스트 resultMap -->
	<resultMap id="getOrderDetailScheduleListResultMap" type="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleListDto">
		<result column="OD_ORDER_DETL_DAILY_SCH_ID"			property="odOrderDetlDailySchId"/>
		<result column="OD_ORDER_DETL_DAILY_SCH_SEQ"			property="odOrderDetlDailySchSeq"/>
		<result column="OD_ORDER_DETL_DAILY_ID"			property="odOrderDetlDailyId"/>
		<result column="DELV_DATE"			property="delvDate"/>
		<result column="ORG_DELV_DATE"			property="orgDelvDate"/>
		<result column="DELV_DATE_WEEK_DAY"			property="delvDateWeekDay"/>
		<result column="DELIVERY_YN"			property="deliveryYn"/>
		<result column="GOODS_IMG_NM"			property="goodsImgNm"/>
		<result column="GOODS_NM"			property="goodsNm"/>
		<result column="ORDER_CNT"			property="orderCnt"/>
		<result column="OD_SHIPPING_ZONE_ID"			property="odShippingZoneId"/>
	</resultMap>
	<select id="getOrderDetailScheduleList" resultMap="getOrderDetailScheduleListResultMap">
		/*	orderDetailSchedule.getOrderDetailScheduleList  */
		SELECT OODDS.OD_ORDER_DETL_DAILY_SCH_ID
			, OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
			, OODDS.OD_ORDER_DETL_DAILY_ID
			<choose>
				<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(listType, "Y")'>
					, OODDS.DELIVERY_DT AS DELV_DATE
					, DAYOFWEEK(OODDS.DELIVERY_DT) AS DELV_DATE_WEEK_DAY
				</when>
				<otherwise>
					, DATE_FORMAT(OODDS.DELIVERY_DT,'%Y년 %m월 %d일') AS DELV_DATE
					, OODDS.DELIVERY_DT AS ORG_DELV_DATE
					, SUBSTR('일월화수목금토', DAYOFWEEK(OODDS.DELIVERY_DT), 1) AS DELV_DATE_WEEK_DAY
				</otherwise>
			</choose>

			, OODDS.DELIVERY_YN
			, FN_GOODS_C_IMG(OOD.IL_GOODS_ID) AS GOODS_IMG_NM
			, OOD.GOODS_NM
			, OODDS.ORDER_CNT
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								<choose>
									<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(promotionYn, "Y")'>
										AND DAILY_PACK_YN = 'N'
										AND OD_ORDER_ID = #{odOrderId}
									</when>
									<otherwise>
										AND OD_ORDER_DETL_ID = #{odOrderDetlId}
									</otherwise>
								</choose>
				)
		) OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
		INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		WHERE OODDS.USE_YN = 'Y'
		<if test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(changeDate)">
			AND OODDS.DELIVERY_DT <![CDATA[ >= ]]> #{changeDate}
		</if>
		<if test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(codeSearchList)">
			AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID IN
			<foreach item="data" index="index" collection="codeSearchList" open="(" separator="," close=")">
				#{data}
			</foreach>
		</if>
		ORDER BY OODDS.DELIVERY_DT ASC
	</select>

	<select id="getOrderDetailScheduleSkipList" resultMap="getOrderDetailScheduleListResultMap">
		/*	orderDetailSchedule.getOrderDetailScheduleSkipList  */
		SELECT OODDS.OD_ORDER_DETL_DAILY_SCH_ID
			, OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
			, OODDS.OD_ORDER_DETL_DAILY_ID
			, OODDS.DELIVERY_DT AS DELV_DATE
			, DAYOFWEEK(OODDS.DELIVERY_DT) AS DELV_DATE_WEEK_DAY
			, OODDS.DELIVERY_YN
			, FN_GOODS_C_IMG(OOD.IL_GOODS_ID) AS GOODS_IMG_NM
			, OOD.GOODS_NM
			, OODDS.ORDER_CNT
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
									AND OD_ORDER_DETL_ID = #{odOrderDetlId}
				)
		) OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
		INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		WHERE OODDS.USE_YN = 'Y'
			AND OODDS.DELIVERY_DT BETWEEN #{firstDate}  AND #{lastDate}
		ORDER BY OODDS.DELIVERY_DT ASC
	</select>

	<select id="getOrderDetailScheduleArrivalInfo" resultMap="getOrderDetailScheduleListResultMap">
		/*	orderDetailSchedule.getOrderDetailScheduleArrivalInfo  */
		SELECT OODDS.OD_ORDER_DETL_DAILY_SCH_ID
			, OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
			, OODDS.OD_ORDER_DETL_DAILY_ID
			, OODDS.DELIVERY_DT AS DELV_DATE
			, DAYOFWEEK(OODDS.DELIVERY_DT) AS DELV_DATE_WEEK_DAY
			, OODDS.DELIVERY_YN
			, FN_GOODS_C_IMG(OOD.IL_GOODS_ID) AS GOODS_IMG_NM
			, OOD.GOODS_NM
			, OODDS.ORDER_CNT
			, OODDS.OD_SHIPPING_ZONE_ID
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
				)
		) OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
		INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		WHERE OODDS.USE_YN = 'Y'
			<if test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(changeDate)">
				AND OODDS.DELIVERY_DT = #{changeDate}
			</if>
			<if test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(odOrderDetlDailySchId)">
				AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
			</if>
	</select>

	<insert id="addOrderDetailSchedule">
		/*	orderDetailSchedule.addOrderDetailSchedule  */
		INSERT INTO OD_ORDER_DETL_DAILY_SCH(
			OD_ORDER_DETL_DAILY_SCH_SEQ
			, OD_ORDER_DETL_DAILY_ID
			, DELIVERY_DT
			, ORDER_CNT
			, ORDER_SCH_STATUS
			, PS_SHIPPING_COMP_ID
			, TRACKING_NO
			, OD_SHIPPING_ZONE_ID
		)
		VALUES
		<foreach item="item" index="index" collection="list" open="" separator="," close="">
			(
				#{item.odOrderDetlDailySchSeq}
				, (
					SELECT OODD.OD_ORDER_DETL_DAILY_ID FROM OD_ORDER_DETL_DAILY OODD
				  	WHERE
					EXISTS ( SELECT 'X'
		   					FROM
		   						OD_ORDER_DETL OOD
							WHERE OOD.OD_ORDER_DETL_ID = OODD.OD_ORDER_DETL_ID
							AND OOD.ODID = #{item.odid}
							AND OOD.OD_ORDER_DETL_SEQ = #{item.odOrderDetlSeq}
					)
				)
				, #{item.deliveryDt}
				, #{item.orderCnt}
				, #{item.orderSchStatus}
				, 0
				, ''
				,	(
						SELECT
							MIN(OD_SHIPPING_ZONE_ID)
						FROM
							OD_ORDER_DETL_DAILY_ZONE
						WHERE
							USE_YN='Y'
						AND OD_ORDER_DETL_ID = #{item.odOrderDetlId}
						AND START_DT = (
						    IFNULL((
								SELECT
									MIN(START_DT)
								FROM
									OD_ORDER_DETL_DAILY_ZONE
								WHERE
									USE_YN='Y'
								AND OD_ORDER_DETL_ID = #{item.odOrderDetlId}
								AND <![CDATA[((START_DT <= #{item.deliveryDt} AND END_DT >= #{item.deliveryDt}) OR START_DT >= #{item.deliveryDt})]]>
							),
							(
								SELECT
									MAX(START_DT)
								FROM
									OD_ORDER_DETL_DAILY_ZONE
								WHERE
									USE_YN='Y'
								AND OD_ORDER_DETL_ID = #{item.odOrderDetlId}
								AND <![CDATA[END_DT <= #{item.deliveryDt}]]>
							))
						)
					)
			)
		</foreach>
	</insert>

	<update id="putOrderDetlSchedule">
		/*	orderDetailSchedule.putOrderDetailSchedule  */
		<foreach collection="list" item="item" separator=";">
			UPDATE OD_ORDER_DETL_DAILY_SCH OODDS
			SET OODDS.USE_YN = 'N'
			<if test='@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(item.orderSchStatus)'>
			  , OODDS.ORDER_SCH_STATUS = #{item.orderSchStatus}
			</if>
			WHERE
				EXISTS ( SELECT 'X'
			   					FROM
			   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{item.odOrderDetlId}
				)
				AND OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ = #{item.odOrderDetlDailySchSeq}
		</foreach>
		;
	</update>

	<update id="putErpOrderDetlSchedule">
		/*	orderDetailSchedule.putErpOrderDetlSchedule  */
		<foreach collection="list" item="item" separator=";">
			UPDATE  OD_ORDER_DETL_DAILY_SCH OODDS
			SET USE_YN = 'N'
			<if test='@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(item.orderSchStatus)'>
			  , ORDER_SCH_STATUS = #{item.orderSchStatus}
			</if>
			WHERE OODDS.OD_ORDER_DETL_DAILY_ID = (
				SELECT OODD.OD_ORDER_DETL_DAILY_ID
				FROM OD_ORDER_DETL_DAILY OODD
			 	WHERE (OODD.OD_ORDER_ID, OODD.OD_ORDER_DETL_ID, OODD.OD_ORDER_DETL_SEQ)
			 	IN (SELECT OOD.OD_ORDER_ID
			 		, OOD.OD_ORDER_DETL_ID
			 		, OOD.OD_ORDER_DETL_SEQ
			 		FROM OD_ORDER_DETL OOD
			 		WHERE OOD.ODID = #{item.odid}
			   		AND OOD.OD_ORDER_DETL_SEQ = #{item.odOrderDetlSeq}
			 		)
				)
			AND OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ = #{item.odOrderDetlDailySchSeq}
		</foreach>
		;
	</update>

	<select id="getOrderDetlScheduleHolidayYn" resultType="java.lang.String">
		/*	orderSchedule.getHolidayYn	*/
		SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) AS HOLIDAY_YN
		FROM PS_HOLIDAY
		WHERE HOLIDAY_DT = #{nowDate}
	</select>

	<!-- 주문상세 스캐줄 요일 리스트 resultMap -->
	<resultMap id="getOrderDetailScheduleDayOfWeekListResultMap" type="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleDayOfWeekListDto">
		<result column="DELV_DATE"			property="delvDate"/>
		<result column="DELV_DATE_WEEK_DAY"			property="delvDateWeekDay"/>
	</resultMap>

	<select id="getOrderDetailScheduleDayOfWeekList" resultMap="getOrderDetailScheduleDayOfWeekListResultMap">
		/*	orderDetailSchedule.getOrderDetailScheduleDayOfWeekList  */
		WITH TBL_WAREHOUSE_HOLIDAY AS (
			SELECT
				A.HOLIDAY
			FROM
				(
				SELECT
					DATE_FORMAT(DATE_ADD(UWH.HOLIDAY_DT, INTERVAL + PSPD.ARRIVAL_SCHEDULED_DAY - PSPD.FORWARDING_SCHEDULED_DAY DAY), '%Y-%m-%d') AS HOLIDAY
				FROM
					UR_WAREHOUSE UW
					JOIN PS_SHIPPING_PATTERN_DAY PSPD ON (PSPD.PS_SHIPPING_PATTERN_ID = UW.PS_SHIPPING_PATTERN_ID)
					JOIN UR_WAREHOUSE_HLDY UWH ON (UWH.UR_WAREHOUSE_ID = UW.UR_WAREHOUSE_ID)
				WHERE
					UW.UR_WAREHOUSE_ID  = #{urWarehouseId}
					AND PSPD.WEEK_CD = (
							CASE WEEKDAY(DATE_ADD(UWH.HOLIDAY_DT, INTERVAL - PSPD.ARRIVAL_SCHEDULED_DAY DAY))
							WHEN 0 THEN 'WEEK_CD.MON'
							WHEN 1 THEN 'WEEK_CD.TUE'
							WHEN 2 THEN 'WEEK_CD.WED'
							WHEN 3 THEN 'WEEK_CD.THU'
							WHEN 4 THEN 'WEEK_CD.FRI'
							WHEN 5 THEN 'WEEK_CD.SAT'
							WHEN 6 THEN 'WEEK_CD.SUN'
							END
							)
					AND UWH.HOLIDAY_DT <![CDATA[>]]> CURRENT_DATE()
					AND UWH.DAWN_DLVRY_YN ='N'
				) A
			GROUP BY A.HOLIDAY
		)
		SELECT DATE_FORMAT(DELV_DATE, '%Y-%m-%d') AS DELV_DATE
			, DAYOFWEEK(DELV_DATE) AS DELV_DATE_WEEK_DAY
		FROM
		(
			SELECT *
				FROM
			(SELECT ADDDATE(NOW() ,T4*10000 + T3*1000 + T2*100 + T1*10 + T0) DELV_DATE FROM
			(SELECT 0 T0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T0,
			(SELECT 0 T1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T1,
			(SELECT 0 T2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T2,
			(SELECT 0 T3 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T3,
			(SELECT 0 T4 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T4) DAY_OF_WEEK_INFO
			WHERE
				NOT EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						PS_HOLIDAY
								WHERE HOLIDAY_DT = DATE_FORMAT(DAY_OF_WEEK_INFO.DELV_DATE, '%Y-%m-%d')

				)
				AND	NOT EXISTS ( SELECT 'X'
   					FROM
						TBL_WAREHOUSE_HOLIDAY
					WHERE
						DATE_FORMAT(HOLIDAY, '%Y-%m-%d') = DATE_FORMAT(DAY_OF_WEEK_INFO.DELV_DATE, '%Y-%m-%d')
				)
		) DAY_OF_WEEK_INFO
		WHERE DAYOFWEEK(DELV_DATE) IN
			<foreach collection="deliveryDayOfWeekList" item="dayOfWeekCode" index="index" separator="," open="(" close=")">
				#{dayOfWeekCode}
			</foreach>
			<choose>
				<when test='scheduleLimit != null and scheduleLimit != 0'>
						AND DATE_FORMAT(DELV_DATE, '%Y-%m-%d') <![CDATA[ > ]]> (
											SELECT
												MAX(DELIVERY_DT)
											FROM
												OD_ORDER_DETL_DAILY_SCH OODDS
											WHERE
												EXISTS ( SELECT 'X'
									 		   					FROM
									 		   						OD_ORDER_DETL_DAILY
																WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
																AND OD_ORDER_DETL_ID = #{odOrderDetlId}
												)
										)
					ORDER BY DELV_DATE ASC
					LIMIT #{scheduleLimit}
				</when>
				<otherwise>
					AND DATE_FORMAT(DELV_DATE, '%Y-%m-%d') BETWEEN #{changeDate}  AND #{changeDate} + INTERVAL 6 MONTH
					ORDER BY DELV_DATE ASC
				</otherwise>
			</choose>
	</select>

	<select id="getOrderDetailScheduleOrderCnt" resultType="int">
		/*	orderDetailSchedule.getOrderDetailScheduleOrderCnt  */
		SELECT IFNULL(SUM(OODDS.ORDER_CNT), 0) AS SCHEDULE_ORDER_CNT
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
				)
		) OODDS
		WHERE OODDS.USE_YN = 'Y'
			AND DELIVERY_DT <![CDATA[ >= ]]> #{changeDate}
		ORDER BY OODDS.DELIVERY_DT ASC
	</select>

	<insert id="addChangeOrderDetailSchedule">
		/*	orderDetailSchedule.addChangeOrderDetailSchedule  */
		INSERT INTO OD_ORDER_DETL_DAILY_SCH(
			OD_ORDER_DETL_DAILY_SCH_SEQ
			, OD_ORDER_DETL_DAILY_ID
			, DELIVERY_DT
			, ORDER_CNT
			, ORDER_SCH_STATUS
			, USE_YN
			, PS_SHIPPING_COMP_ID
			, TRACKING_NO
			, OD_SHIPPING_ZONE_ID
		)
		VALUES
		(
			<choose>
				<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(orderSchStatus, "1")'>
					(SELECT IFNULL(MAX(OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ)+1, 1) FROM OD_ORDER_DETL_DAILY_SCH OODDS WHERE OODDS.OD_ORDER_DETL_DAILY_ID = #{odOrderDetlDailyId})
				</when>
				<otherwise>
					#{odOrderDetlDailySchSeq}
				</otherwise>
			</choose>
			, #{odOrderDetlDailyId}
			, #{deliveryDt}
			, #{orderCnt}
			, #{orderSchStatus}
			, #{useYn}
			, 0
			, ''
			, <choose>
				<when test="odShippingZoneId != null and odShippingZoneId != 0">
					#{odShippingZoneId}
				</when>
				<otherwise>
					(
						SELECT
							MIN(OD_SHIPPING_ZONE_ID)
						FROM
							OD_ORDER_DETL_DAILY_ZONE
						WHERE
							USE_YN='Y'
						AND OD_ORDER_DETL_ID = #{odOrderDetlId}
						AND START_DT = (
							IFNULL((
								SELECT
									MIN(START_DT)
								FROM
									OD_ORDER_DETL_DAILY_ZONE
								WHERE
									USE_YN='Y'
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
								AND <![CDATA[((START_DT <= #{deliveryDt} AND END_DT >= #{deliveryDt}) OR START_DT >= #{deliveryDt})]]>
							),
							(
								SELECT
									MAX(START_DT)
								FROM
									OD_ORDER_DETL_DAILY_ZONE
								WHERE
									USE_YN='Y'
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
								AND <![CDATA[END_DT <= #{deliveryDt}]]>
							))
						)
					)
				</otherwise>
			</choose>
		)
		<selectKey resultType="int" keyProperty="odOrderDetlDailySchSeq" keyColumn="OD_ORDER_DETL_DAILY_SCH_SEQ" order="AFTER">
			SELECT IFNULL(MAX(OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ), 0) FROM OD_ORDER_DETL_DAILY_SCH OODDS WHERE OODDS.OD_ORDER_DETL_DAILY_ID = #{odOrderDetlDailyId}
		</selectKey>
	</insert>

	<update id="putSkipOrderDetailSchedule">
		/*	orderDetailSchedule.putSkipOrderDetlSchedule  */
		<foreach collection="list" item="item" separator=";">
			UPDATE OD_ORDER_DETL_DAILY_SCH OODDS
			SET OODDS.USE_YN = 'N'
			WHERE
				OD_ORDER_DETL_DAILY_SCH_ID = #{item.odOrderDetlDailySchId}
		</foreach>
		;
	</update>

	<insert id="addSkipOrderDetailSchedule">
		/*	orderDetailSchedule.addSkipOrderDetailSchedule  */
		INSERT INTO OD_ORDER_DETL_DAILY_SCH(
			OD_ORDER_DETL_DAILY_SCH_SEQ
			, OD_ORDER_DETL_DAILY_ID
			, DELIVERY_DT
			, ORDER_CNT
			, ORDER_SCH_STATUS
			, USE_YN
			, PS_SHIPPING_COMP_ID
			, TRACKING_NO
			, OD_SHIPPING_ZONE_ID
		)
		SELECT
			<choose>
				<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(orderSchStatus, "1")'>
					(
						SELECT IFNULL(MAX(OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ)+1, 1) AS OD_ORDER_DETL_DAILY_SCH_SEQ
						FROM OD_ORDER_DETL_DAILY_SCH OODDS
						WHERE
							EXISTS
							(
								SELECT 'X'
			 		   			FROM
			 		   			OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
							)
					)
				</when>
				<otherwise>
					(
						SELECT OD_ORDER_DETL_DAILY_SCH_SEQ
						FROM OD_ORDER_DETL_DAILY_SCH
						WHERE
							OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
					)
				</otherwise>
			</choose>
			, OD_ORDER_DETL_DAILY_ID
			<choose>
				<when test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(deliveryDt) and @kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(orderCnt)">
					, #{deliveryDt}
					, #{orderCnt}
				</when>
				<otherwise>
					, DELIVERY_DT
					, ORDER_CNT
				</otherwise>
			</choose>
			, #{orderSchStatus}
			, #{useYn}
			, 0
			, ''
			, <choose>
				<when test="odShippingZoneId != null and odShippingZoneId != 0">
					#{odShippingZoneId}
				</when>
				<otherwise>
					(
						SELECT
							OD_SHIPPING_ZONE_ID
							FROM
							OD_ORDER_DETL_DAILY_ZONE
							WHERE
								USE_YN='Y'
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
								AND START_DT <![CDATA[ <= ]]> #{deliveryDt}
								AND END_DT <![CDATA[ >= ]]> #{deliveryDt}
					)
				</otherwise>
			</choose>
		FROM OD_ORDER_DETL_DAILY_SCH
		WHERE OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
	</insert>

	<select id="getOrderDetailBatchInfo" resultType="String">
		/*	orderDetailSchedule.getOrderDetailBatchInfo  */
		SELECT BATCH_EXEC_FL
		FROM
			OD_ORDER_DETL
		WHERE OD_ORDER_DETL_ID = #{odOrderDetlId}
	</select>

	<select id="getOrderDetailDailySchSeq" resultType="int">
		/*	orderDetailSchedule.getOrderDetailDailySchSeq  */
		SELECT
			MAX(OODDS.OD_ORDER_DETL_DAILY_SCH_ID) AS orderDetailDailySchSeq
		FROM
			OD_ORDER_DETL_DAILY_SCH OODDS
		WHERE
			EXISTS ( SELECT 'X'
		   					FROM
		   						OD_ORDER_DETL_DAILY
							WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
							AND OD_ORDER_DETL_ID = #{odOrderDetlId}
			)
	</select>

	<delete id="delOdOrderDetlDailySch">
		/*	orderDetailSchedule.delOdOrderDetlDailySch  */
		DELETE
		FROM OD_ORDER_DETL_DAILY_SCH OODDS
		WHERE
			EXISTS ( SELECT 'X'
		   					FROM
		   						OD_ORDER_DETL_DAILY
							WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
							AND OD_ORDER_DETL_ID = #{odOrderDetlId}
			)
			<if test="odOrderDetlDailySchSeq != null and odOrderDetlDailySchSeq != 0">
				AND OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ = #{odOrderDetlDailySchSeq}
			</if>
			<if test="odOrderDetlDailySchId != null and odOrderDetlDailySchId != 0">
				AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
			</if>
	</delete>

	<select id="getErpOrderDetailScheduleList" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailGreenJuiceListDto">
		/*	orderDetailSchedule.getErpOrderDetailScheduleList  */
        SELECT
            X.OD_ORDER_ID AS odOrderId
            , X.ODID AS odid
            , X.OD_ORDER_DETL_ID AS odOrderDetlId
            , X.OD_ORDER_DETL_SEQ AS odOrderDetlSeq
            , X.ORDER_HPN_CD AS orderHpnCd
            , X.CREATE_DT AS createDt
            , X.BUYER_NM AS buyerNm
            , X.BUYER_TEL AS buyerTel
            , X.BUYER_HP AS buyerHp
            , X.BUYER_MAIL AS buyerMail
            , X.RECV_NM AS recvNm
            , X.RECV_TEL AS recvTel
            , X.RECV_HP AS recvHp
            , CONCAT(X.RECV_ADDR1, ' ', X.RECV_ADDR2) AS recvAddr
            , X.RECV_ADDR1 AS recvAddr1
            , X.RECV_ADDR2 AS recvAddr2
            , X.RECV_BLD_NO AS recvBldNo
            , X.RECV_ZIP_CD AS recvZipCd
            , X.DELIVERY_MSG AS deliveryMsg
            , X.DOOR_MSG_NM AS doorMsgNm
            , X.DOOR_MSG AS doorMsg
            , X.IL_ITEM_CD AS ilItemCd
            , X.ORDER_CANCEL_CNT AS orderCancelCnt
            , X.DELIVERY_DT AS deliveryDt
            , IFNULL(X.SALE_PRICE, 0) AS salePrice
            , X.GOODS_TP_CD AS goodsTpCd
            , X.SEQ_NO AS seqNo
            , X.OD_ORDER_DETL_DAILY_ID AS odOrderDetlDailyId
            , X.OD_ORDER_DETL_DAILY_SCH_ID AS odOrderDetlDailySchId
            , X.OD_ORDER_DETL_DAILY_SCH_SEQ AS odOrderDetlDailySchSeq
            , X.ORDER_SCH_STATUS AS orderSchStatus
            , X.ORDER_CNT AS orderCnt
            , X.UR_STORE_ID AS urStoreId
            , X.MON_CNT AS monCnt
            , X.TUE_CNT AS tueCnt
            , X.WED_CNT AS wedCnt
            , X.THU_CNT AS thuCnt
            , X.FRI_CNT AS friCnt
            , X.GOODS_CYCLE_TERM_TP_NM AS goodsCycleTermTpNm
            , X.OD_SHIPPING_ZONE_ID AS odShippingZoneId
        FROM
        (
            SELECT
                OO.OD_ORDER_ID
                , OO.ODID
                , OOD.OD_ORDER_DETL_ID
                , OOD.OD_ORDER_DETL_SEQ
                , OO.ORDER_HPN_CD
                , DATE_FORMAT(OO.CREATE_DT, '%Y%m%d%H%i%s') AS CREATE_DT
                , FN_DECRYPT(OO.BUYER_NM) AS BUYER_NM
                , FN_DECRYPT(OO.BUYER_TEL) AS BUYER_TEL
                , FN_DECRYPT(OO.BUYER_HP) AS BUYER_HP
                , FN_DECRYPT(OO.BUYER_MAIL) AS BUYER_MAIL
                , FN_DECRYPT(OSZ.RECV_NM) AS RECV_NM
                , FN_DECRYPT(OSZ.RECV_TEL) AS RECV_TEL
                , FN_DECRYPT(OSZ.RECV_HP) AS RECV_HP
                , FN_DECRYPT(OSZ.RECV_ADDR1) AS RECV_ADDR1
                , FN_DECRYPT(OSZ.RECV_ADDR2) AS RECV_ADDR2
                , OSZ.RECV_BLD_NO
                , FN_DECRYPT(OSZ.RECV_ZIP_CD) AS RECV_ZIP_CD
                , OSZ.DELIVERY_MSG
                , FN_COMN_CODE_DIC(OSZ.DOOR_MSG_CD) AS DOOR_MSG_NM
                , FN_DECRYPT(OSZ.DOOR_MSG) AS DOOR_MSG
                , OOD.IL_ITEM_CD
                , (OOD.ORDER_CNT - OOD.CANCEL_CNT) AS ORDER_CANCEL_CNT
                , DATE_FORMAT(OODDS.DELIVERY_DT, '%Y%m%d%H%i%s') AS DELIVERY_DT
                , CASE
                    WHEN OO.ORDER_HPN_CD IN ('0003', '0024') THEN (OOD.RECOMMENDED_PRICE * (OOD.ORDER_CNT - OOD.CANCEL_CNT))
                    WHEN OO.ORDER_HPN_CD NOT IN ('0003', '0024') THEN (OOD.SALE_PRICE * (OOD.ORDER_CNT - OOD.CANCEL_CNT))
                  END AS SALE_PRICE
                , OOD.GOODS_TP_CD
                , DATE_FORMAT(now(), '%H%i%s') AS SEQ_NO
                , OODD.OD_ORDER_DETL_DAILY_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
                , OODDS.ORDER_SCH_STATUS
                , OODDS.ORDER_CNT
                , OODDS.OD_SHIPPING_ZONE_ID
                , OODD.UR_STORE_ID
                , OODD.MON_CNT
                , OODD.TUE_CNT
                , OODD.WED_CNT
                , OODD.THU_CNT
                , OODD.FRI_CNT
                , FN_COMN_CODE_DIC(OODD.GOODS_CYCLE_TERM_TP) AS GOODS_CYCLE_TERM_TP_NM
            FROM OD_ORDER OO
            INNER JOIN OD_ORDER_DETL OOD ON OO.OD_ORDER_ID = OOD.OD_ORDER_ID
            INNER JOIN OD_ORDER_DETL_DAILY OODD ON OO.OD_ORDER_ID = OODD.OD_ORDER_ID AND OOD.OD_ORDER_DETL_ID = OODD.OD_ORDER_DETL_ID
            INNER JOIN OD_ORDER_DETL_DAILY_SCH OODDS ON OODD.OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
            	<if test="odOrderDetlDailySchSeq != null and odOrderDetlDailySchSeq != 0">
            		AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID <![CDATA[ > ]]> #{odOrderDetlDailySchSeq}
            	</if>
            	<if test="odOrderDetlDailySchId != null and odOrderDetlDailySchId != 0">
					AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
				</if>
            LEFT JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_ORDER_ID = OSZ.OD_ORDER_ID AND OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
            WHERE OOD.OD_ORDER_DETL_ID = #{odOrderDetlId}
        ) X
        ORDER BY X.OD_ORDER_DETL_DAILY_SCH_ID ASC
	</select>

	<select id="getErpOrderDetailScheduleListByDeliveryDt" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailGreenJuiceListDto">
		/*	orderDetailSchedule.getErpOrderDetailScheduleListByDeliveryDt  */
        SELECT
            X.OD_ORDER_ID AS odOrderId
            , X.ODID AS odid
            , X.OD_ORDER_DETL_ID AS odOrderDetlId
            , X.OD_ORDER_DETL_SEQ AS odOrderDetlSeq
            , X.ORDER_HPN_CD AS orderHpnCd
            , X.CREATE_DT AS createDt
            , X.BUYER_NM AS buyerNm
            , X.BUYER_TEL AS buyerTel
            , X.BUYER_HP AS buyerHp
            , X.BUYER_MAIL AS buyerMail
            , X.RECV_NM AS recvNm
            , X.RECV_TEL AS recvTel
            , X.RECV_HP AS recvHp
            , CONCAT(X.RECV_ADDR1, ' ', X.RECV_ADDR2) AS recvAddr
            , X.RECV_ADDR1 AS recvAddr1
            , X.RECV_ADDR2 AS recvAddr2
            , X.RECV_BLD_NO AS recvBldNo
            , X.RECV_ZIP_CD AS recvZipCd
            , X.DELIVERY_MSG AS deliveryMsg
            , X.DOOR_MSG_NM AS doorMsgNm
            , X.DOOR_MSG AS doorMsg
            , X.IL_ITEM_CD AS ilItemCd
            , X.ORDER_CANCEL_CNT AS orderCancelCnt
            , X.DELIVERY_DT AS deliveryDt
            , IFNULL(X.SALE_PRICE, 0) AS salePrice
            , X.GOODS_TP_CD AS goodsTpCd
            , X.TAX_YN AS taxYn
            , X.SEQ_NO AS seqNo
            , X.OD_ORDER_DETL_DAILY_ID AS odOrderDetlDailyId
            , X.OD_ORDER_DETL_DAILY_SCH_ID AS odOrderDetlDailySchId
            , X.OD_ORDER_DETL_DAILY_SCH_SEQ AS odOrderDetlDailySchSeq
            , X.ORDER_SCH_STATUS AS orderSchStatus
            , X.ORDER_CNT AS orderCnt
            , X.UR_STORE_ID AS urStoreId
            , X.MON_CNT AS monCnt
            , X.TUE_CNT AS tueCnt
            , X.WED_CNT AS wedCnt
            , X.THU_CNT AS thuCnt
            , X.FRI_CNT AS friCnt
            , X.GOODS_CYCLE_TERM_TP_NM AS goodsCycleTermTpNm
            , X.OD_SHIPPING_ZONE_ID AS odShippingZoneId
        	, X.USE_YN AS useYn
			, IFNULL((SELECT ATTR1 FROM ST_COMN_CODE WHERE ST_COMN_CODE_ID = 'SHI_TO_ORG_ID.HITOK'), 0) AS supplierCd
        FROM
        (
            SELECT
                OO.OD_ORDER_ID
                , OO.ODID
                , OOD.OD_ORDER_DETL_ID
                , OOD.OD_ORDER_DETL_SEQ
                , OO.ORDER_HPN_CD
                , DATE_FORMAT(OO.CREATE_DT, '%Y%m%d%H%i%s') AS CREATE_DT
                , FN_DECRYPT(OO.BUYER_NM) AS BUYER_NM
                , FN_DECRYPT(OO.BUYER_TEL) AS BUYER_TEL
                , FN_DECRYPT(OO.BUYER_HP) AS BUYER_HP
                , FN_DECRYPT(OO.BUYER_MAIL) AS BUYER_MAIL
                , FN_DECRYPT(OSZ.RECV_NM) AS RECV_NM
                , FN_DECRYPT(OSZ.RECV_TEL) AS RECV_TEL
                , FN_DECRYPT(OSZ.RECV_HP) AS RECV_HP
                , FN_DECRYPT(OSZ.RECV_ADDR1) AS RECV_ADDR1
                , FN_DECRYPT(OSZ.RECV_ADDR2) AS RECV_ADDR2
                , OSZ.RECV_BLD_NO
                , FN_DECRYPT(OSZ.RECV_ZIP_CD) AS RECV_ZIP_CD
                , OSZ.DELIVERY_MSG
                , FN_COMN_CODE_DIC(OSZ.DOOR_MSG_CD) AS DOOR_MSG_NM
                , FN_DECRYPT(OSZ.DOOR_MSG) AS DOOR_MSG
                , OOD.IL_ITEM_CD
                , (OOD.ORDER_CNT - OOD.CANCEL_CNT) AS ORDER_CANCEL_CNT
                , DATE_FORMAT(OODDS.DELIVERY_DT, '%Y%m%d%H%i%s') AS DELIVERY_DT
                , CASE
                    WHEN OO.ORDER_HPN_CD IN ('0003', '0024') THEN (OOD.RECOMMENDED_PRICE * OODDS.ORDER_CNT)
                    WHEN OO.ORDER_HPN_CD NOT IN ('0003', '0024') THEN (OOD.SALE_PRICE * OODDS.ORDER_CNT)
                  END AS SALE_PRICE
                , OOD.GOODS_TP_CD
                , OOD.TAX_YN
                , DATE_FORMAT(now(), '%H%i%s') AS SEQ_NO
                , OODD.OD_ORDER_DETL_DAILY_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
                , OODDS.ORDER_SCH_STATUS
                , OODDS.ORDER_CNT
                , OODDS.OD_SHIPPING_ZONE_ID
                , OODD.UR_STORE_ID
                , OODD.MON_CNT
                , OODD.TUE_CNT
                , OODD.WED_CNT
                , OODD.THU_CNT
                , OODD.FRI_CNT
                , FN_COMN_CODE_DIC(OODD.GOODS_CYCLE_TERM_TP) AS GOODS_CYCLE_TERM_TP_NM
            	, OODDS.USE_YN
            FROM OD_ORDER OO
            INNER JOIN OD_ORDER_DETL OOD ON OO.OD_ORDER_ID = OOD.OD_ORDER_ID
            INNER JOIN OD_ORDER_DETL_DAILY OODD ON OO.OD_ORDER_ID = OODD.OD_ORDER_ID AND OOD.OD_ORDER_DETL_ID = OODD.OD_ORDER_DETL_ID
            INNER JOIN OD_ORDER_DETL_DAILY_SCH OODDS ON OODD.OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
                									AND OODDS.DELIVERY_DT <![CDATA[>=]]> #{deliveryDt}
            LEFT JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_ORDER_ID = OSZ.OD_ORDER_ID AND OODDS.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
            WHERE OOD.OD_ORDER_DETL_ID = #{odOrderDetlId}
            AND   OODDS.API_CANCEL_SEND_YN = 'N'
        ) X
        ORDER BY X.OD_ORDER_DETL_DAILY_SCH_ID ASC
	</select>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문 녹즙 ERP 전송 스캐줄 리스트 조회
	 * @
	 * @ 수정일			수정자          수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.07.12 	김명진          최초생성
	 * @
	────────────────────────────────────────────────────────────────────────-->
	<sql id="getErpOrderDetailScheduleList">
        SELECT
            X.OD_ORDER_ID AS odOrderId
            , X.ODID AS odid
            , X.OD_ORDER_DETL_ID AS odOrderDetlId
            , X.OD_ORDER_DETL_SEQ AS odOrderDetlSeq
            , X.ORDER_HPN_CD AS orderHpnCd
            , X.CREATE_DT AS createDt
            , X.BUYER_NM AS buyerNm
            , X.BUYER_TEL AS buyerTel
            , X.BUYER_HP AS buyerHp
            , X.BUYER_MAIL AS buyerMail
            , X.RECV_NM AS recvNm
            , X.RECV_TEL AS recvTel
            , X.RECV_HP AS recvHp
            , CONCAT(X.RECV_ADDR1, ' ', X.RECV_ADDR2) AS recvAddr
            , X.RECV_ADDR1 AS recvAddr1
            , X.RECV_ADDR2 AS recvAddr2
            , X.RECV_BLD_NO AS recvBldNo
            , X.RECV_ZIP_CD AS recvZipCd
            , X.DELIVERY_MSG AS deliveryMsg
            , X.DOOR_MSG_NM AS doorMsgNm
            , X.DOOR_MSG AS doorMsg
            , X.IL_ITEM_CD AS ilItemCd
            , X.ORDER_CANCEL_CNT AS orderCancelCnt
            , X.DELIVERY_DT AS deliveryDt
            , IFNULL(X.SALE_PRICE, 0) AS salePrice
            , X.GOODS_TP_CD AS goodsTpCd
            , X.TAX_YN AS taxYn
            , X.SEQ_NO AS seqNo
            , X.OD_ORDER_DETL_DAILY_ID AS odOrderDetlDailyId
            , X.OD_ORDER_DETL_DAILY_SCH_ID AS odOrderDetlDailySchId
            , X.OD_ORDER_DETL_DAILY_SCH_SEQ AS odOrderDetlDailySchSeq
            , X.ORDER_SCH_STATUS AS orderSchStatus
            , X.ORDER_CNT AS orderCnt
            , X.UR_STORE_ID AS urStoreId
            , X.MON_CNT AS monCnt
            , X.TUE_CNT AS tueCnt
            , X.WED_CNT AS wedCnt
            , X.THU_CNT AS thuCnt
            , X.FRI_CNT AS friCnt
			, X.GOODS_CYCLE_TP AS goodsCycleTp
            , X.GOODS_CYCLE_TERM_TP_NM AS goodsCycleTermTpNm
            , X.OD_SHIPPING_ZONE_ID AS odShippingZoneId
        	, X.USE_YN AS useYn
			, IFNULL((SELECT ATTR1 FROM ST_COMN_CODE WHERE ST_COMN_CODE_ID = 'SHI_TO_ORG_ID.HITOK'), 0) AS supplierCd
        FROM
        (
            SELECT
                OO.OD_ORDER_ID
                , OO.ODID
                , OOD.OD_ORDER_DETL_ID
                , OOD.OD_ORDER_DETL_SEQ
                , OO.ORDER_HPN_CD
                , DATE_FORMAT(OO.CREATE_DT, '%Y%m%d%H%i%s') AS CREATE_DT
                , FN_DECRYPT(OO.BUYER_NM) AS BUYER_NM
                , FN_DECRYPT(OO.BUYER_TEL) AS BUYER_TEL
                , FN_DECRYPT(OO.BUYER_HP) AS BUYER_HP
                , FN_DECRYPT(OO.BUYER_MAIL) AS BUYER_MAIL
                , FN_DECRYPT(OSZ.RECV_NM) AS RECV_NM
                , FN_DECRYPT(OSZ.RECV_TEL) AS RECV_TEL
                , FN_DECRYPT(OSZ.RECV_HP) AS RECV_HP
                , FN_DECRYPT(OSZ.RECV_ADDR1) AS RECV_ADDR1
                , FN_DECRYPT(OSZ.RECV_ADDR2) AS RECV_ADDR2
                , OSZ.RECV_BLD_NO
                , FN_DECRYPT(OSZ.RECV_ZIP_CD) AS RECV_ZIP_CD
                , OSZ.DELIVERY_MSG
                , FN_COMN_CODE_DIC(OSZ.DOOR_MSG_CD) AS DOOR_MSG_NM
                , FN_DECRYPT(OSZ.DOOR_MSG) AS DOOR_MSG
                , OOD.IL_ITEM_CD
                , (OOD.ORDER_CNT - OOD.CANCEL_CNT) AS ORDER_CANCEL_CNT
                , DATE_FORMAT(OODDS.DELIVERY_DT, '%Y%m%d%H%i%s') AS DELIVERY_DT
                , CASE
                    WHEN OO.ORDER_HPN_CD IN ('0003', '0024') THEN (OOD.RECOMMENDED_PRICE * OODDS.ORDER_CNT)
                    WHEN OO.ORDER_HPN_CD NOT IN ('0003', '0024') THEN (OOD.SALE_PRICE * OODDS.ORDER_CNT)
                  END AS SALE_PRICE
                , OOD.GOODS_TP_CD
				, OOD.TAX_YN
                , DATE_FORMAT(now(), '%H%i%s') AS SEQ_NO
                , OODD.OD_ORDER_DETL_DAILY_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_ID
                , OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ
                , OODDS.ORDER_SCH_STATUS
                , OODDS.ORDER_CNT
                , OODDS.OD_SHIPPING_ZONE_ID
                , OODD.UR_STORE_ID
                , OODD.MON_CNT
                , OODD.TUE_CNT
                , OODD.WED_CNT
                , OODD.THU_CNT
                , OODD.FRI_CNT
				, OODD.GOODS_CYCLE_TP
                , FN_COMN_CODE_DIC(OODD.GOODS_CYCLE_TERM_TP) AS GOODS_CYCLE_TERM_TP_NM
				, OODDS.USE_YN
            FROM OD_ORDER OO
            INNER JOIN OD_ORDER_DETL OOD ON OO.OD_ORDER_ID = OOD.OD_ORDER_ID
            INNER JOIN OD_ORDER_DETL_DAILY OODD ON OO.OD_ORDER_ID = OODD.OD_ORDER_ID AND OOD.OD_ORDER_DETL_ID = OODD.OD_ORDER_DETL_ID
            INNER JOIN OD_ORDER_DETL_DAILY_SCH OODDS ON OODD.OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
					AND OODDS.OD_ORDER_DETL_DAILY_SCH_SEQ IN
					<foreach item="updateSchedule" index="index" collection="updateScheduleList" open="(" separator="," close=")">
						#{updateSchedule.odOrderDetlDailySchSeq}
					</foreach>
            LEFT JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_ORDER_ID = OSZ.OD_ORDER_ID AND OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
            WHERE OOD.OD_ORDER_DETL_ID = #{odOrderDetlId}
			AND   OODDS.API_CANCEL_SEND_YN = 'N'
        ) X
        ORDER BY X.OD_ORDER_DETL_DAILY_SCH_ID ASC
	</sql>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문 녹즙 ERP 전송 스캐줄 리스트 조회 By 취소 수정 리스트
	 * @
	 * @ 수정일			수정자          수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.07.12 	김명진          최초생성
	 * @
	────────────────────────────────────────────────────────────────────────-->
	<select id="getErpOrderDetailScheduleListByCancelUpdateList" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailGreenJuiceListDto">
		/*	orderDetailSchedule.getErpOrderDetailScheduleListByCancelUpdateList  */
		<include refid="getErpOrderDetailScheduleList" />
	</select>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문 녹즙 ERP 전송 스캐줄 리스트 조회 By 등록 리스트
	 * @
	 * @ 수정일			수정자          수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.07.12 	김명진          최초생성
	 * @
	────────────────────────────────────────────────────────────────────────-->
	<select id="getErpOrderDetailScheduleListByInsertList" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailGreenJuiceListDto">
		/*	orderDetailSchedule.getErpOrderDetailScheduleListByInsertList  */
		<include refid="getErpOrderDetailScheduleList" />
	</select>

	<select id="getOrderDetailScheduleInfo" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleInfoDto">
		/*	orderDetailSchedule.getOrderDetailScheduleInfo  */
		SELECT OODDS.DELIVERY_DT AS DELV_DATE
			, FN_DECRYPT(OSZ.RECV_ZIP_CD) 	AS RECV_ZIP_CD	/* 수령인 우편번호 */
		    , OSZ.RECV_BLD_NO
		    , OOD.IL_GOODS_ID
		    , OOD.UR_WAREHOUSE_ID
		FROM
		(
			SELECT
				*
			FROM
				OD_ORDER_DETL_DAILY_SCH OODDS
			WHERE
				EXISTS ( SELECT 'X'
	 		   					FROM
	 		   						OD_ORDER_DETL_DAILY
								WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
				)
		) OODDS
		INNER JOIN OD_ORDER_DETL_DAILY OODD ON OODDS.OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
		INNER JOIN OD_ORDER_DETL OOD ON OODD.OD_ORDER_DETL_ID = OOD.OD_ORDER_DETL_ID
		INNER JOIN OD_SHIPPING_ZONE OSZ ON OOD.OD_SHIPPING_ZONE_ID = OSZ.OD_SHIPPING_ZONE_ID
		WHERE OODDS.USE_YN = 'Y'
			AND OODDS.OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
	</select>

	<select id="getOdOrderDetlId" resultType="long">
		/*	orderDetailSchedule.getOdOrderDetlId  */
		SELECT
			OD_ORDER_DETL_ID
		FROM
			OD_ORDER_DETL_DAILY OODD
		WHERE
			EXISTS ( SELECT 'X'
 		   					FROM
 		   						OD_ORDER_DETL_DAILY_SCH
							WHERE OD_ORDER_DETL_DAILY_ID = OODD.OD_ORDER_DETL_DAILY_ID
							AND OD_ORDER_DETL_DAILY_SCH_ID = #{odOrderDetlDailySchId}
			)
	</select>

	<select id="getOrderDetailScheduleDayOfWeekInfo" resultType="String">
		/*	orderDetailSchedule.getOrderDetailScheduleDayOfWeekInfo  */
		SELECT
			DISTINCT DAYOFWEEK(OODDS.DELIVERY_DT) AS DELV_DATE_WEEK_DAY
		FROM
			OD_ORDER_DETL_DAILY_SCH OODDS
		WHERE
			EXISTS ( SELECT 'X'
 		   					FROM
 		   						OD_ORDER_DETL_DAILY
							WHERE OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
							AND OD_ORDER_DETL_ID = #{odOrderDetlId}
			)
		AND OODDS.USE_YN = 'Y'
		GROUP BY OODDS.DELIVERY_DT
	</select>

	<update id="putOrderDetlSchedulePattern">
	/*	orderDetailSchedule.putOrderDetlSchedulePattern  */
		UPDATE OD_ORDER_DETL_DAILY
		SET DAILY_PATTERN = #{deliveryDayOfWeekList}
		WHERE
			OD_ORDER_DETL_ID = #{odOrderDetlId}
	</update>

	<select id="getOrderDetailScheduleDeliveryDt" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleDateInfoDto">
		/*	orderDetailSchedule.getOrderDetailScheduleDeliveryDt  */
		SELECT
			OD_SHIPPING_ZONE_ID, START_DT AS STARTDATE, END_DT AS ENDDATE
		FROM
			OD_ORDER_DETL_DAILY_ZONE
		WHERE
			USE_YN='Y'
			AND OD_ORDER_DETL_ID = #{odOrderDetlId}
			ORDER BY START_DT ASC
	</select>

	<select id="getOrderDetailScheduleShippingInfo" resultType="kr.co.pulmuone.v1.order.schedule.dto.OrderDetailScheduleShippingInfoDto">
		/*	orderDetailSchedule.getOrderDetailScheduleShippingInfo  */
		SELECT
			OOD.OD_ORDER_ID
			, OOD.ODID
			, OO.ORDER_HPN_CD
			, DATE_FORMAT(OO.CREATE_DT, '%Y%m%d%H%i%s') AS CREATE_DT
	        , FN_DECRYPT(OO.BUYER_NM) AS BUYER_NM
	        , FN_DECRYPT(OO.BUYER_TEL) AS BUYER_TEL
	        , FN_DECRYPT(OO.BUYER_HP) AS BUYER_HP
	        , FN_DECRYPT(OO.BUYER_MAIL) AS BUYER_MAIL
	        , FN_DECRYPT(OSZ.RECV_NM) AS RECV_NM
	        , FN_DECRYPT(OSZ.RECV_TEL) AS RECV_TEL
	        , FN_DECRYPT(OSZ.RECV_HP) AS RECV_HP
	        , CONCAT(FN_DECRYPT(OSZ.RECV_ADDR1), ' ', FN_DECRYPT(OSZ.RECV_ADDR2)) AS RECV_ADDR
	        , FN_DECRYPT(OSZ.RECV_ADDR1) AS RECV_ADDR1
	        , FN_DECRYPT(OSZ.RECV_ADDR2) AS RECV_ADDR2
	        , OSZ.RECV_BLD_NO
	        , FN_DECRYPT(OSZ.RECV_ZIP_CD) AS RECV_ZIP_CD
	        , OSZ.DELIVERY_MSG
	        , FN_COMN_CODE_DIC(OSZ.DOOR_MSG_CD) AS DOOR_MSG_NM
	        , FN_DECRYPT(OSZ.DOOR_MSG) AS DOOR_MSG
	        , DATE_FORMAT(now(6), '%H%i%s%f') AS SEQ_NO
		FROM OD_SHIPPING_ZONE OSZ
		INNER JOIN OD_ORDER_DETL OOD ON OSZ.OD_ORDER_ID = OOD.OD_ORDER_ID AND OOD.OD_ORDER_DETL_ID = #{odOrderDetlId}
		INNER JOIN OD_ORDER OO ON OSZ.OD_ORDER_ID = OO.OD_ORDER_ID
		WHERE OSZ.OD_SHIPPING_ZONE_ID = #{odShippingZoneId}
	</select>

	<update id="putOrderDetlDailyZone">
		/*	orderDetailSchedule.putOrderDetlDailyZone  */
		UPDATE OD_ORDER_DETL_DAILY_ZONE
		SET USE_YN = 'N'
		WHERE
			OD_ORDER_DETL_ID IN
			<choose>
				<when test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(odOrderId)">
					(SELECT OD_ORDER_DETL_ID  FROM OD_ORDER_DETL WHERE OD_ORDER_ID = #{odOrderId})
				</when>
				<otherwise>
					(#{odOrderDetlId})
				</otherwise>
			</choose>

	</update>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문상세 일일배송 배송지 등록
	 * @ 수정일			수정자		  수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.04.27		천혜현	  		최초생성
	────────────────────────────────────────────────────────────────────────-->
	<insert id="addOrderDetlDailyZoneByOdOrderDetlId" >
		/*	orderDetailSchedule.addOrderDetlDailyZoneByOdOrderDetlId  */
		INSERT INTO OD_ORDER_DETL_DAILY_ZONE
		(OD_ORDER_DETL_ID, OD_SHIPPING_ZONE_ID, START_DT, END_DT, USE_YN)
		SELECT
			T1.OD_ORDER_DETL_ID,
			T2.OD_SHIPPING_ZONE_ID,
			(SELECT MIN(DELIVERY_DT) FROM OD_ORDER_DETL_DAILY_SCH WHERE USE_YN = 'Y' AND OD_SHIPPING_ZONE_ID = T1.OD_SHIPPING_ZONE_ID AND OD_ORDER_DETL_DAILY_ID IN
					(SELECT OD_ORDER_DETL_DAILY_ID FROM OD_ORDER_DETL_DAILY T1 WHERE OD_ORDER_DETL_SEQ <![CDATA[>]]> 0
						<choose>
							<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(promotionTp, "CART_PROMOTION_TP.GREENJUICE_SELECT")'>
								AND OD_ORDER_ID = (SELECT OD_ORDER_ID FROM OD_ORDER_DETL WHERE OD_ORDER_DETL_ID = #{odOrderDetlId})
							</when>
							<otherwise>
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
							</otherwise>
						</choose>
					)) AS START_DT,
			(SELECT MAX(DELIVERY_DT) FROM OD_ORDER_DETL_DAILY_SCH WHERE USE_YN ='Y' AND OD_SHIPPING_ZONE_ID = T1.OD_SHIPPING_ZONE_ID AND OD_ORDER_DETL_DAILY_ID IN
					(SELECT OD_ORDER_DETL_DAILY_ID FROM OD_ORDER_DETL_DAILY T1 WHERE OD_ORDER_DETL_SEQ <![CDATA[>]]> 0
						<choose>
							<when test='@kr.co.pulmuone.v1.comm.util.StringUtil@isEquals(promotionTp, "CART_PROMOTION_TP.GREENJUICE_SELECT")'>
								AND OD_ORDER_ID = (SELECT OD_ORDER_ID FROM OD_ORDER_DETL WHERE OD_ORDER_DETL_ID = #{odOrderDetlId})
							</when>
							<otherwise>
								AND OD_ORDER_DETL_ID = #{odOrderDetlId}
							</otherwise>
						</choose>
					)) AS END_DT,
			'Y'AS USE_YN
		FROM
			( SELECT
				OODDS.OD_SHIPPING_ZONE_ID
				,OODD.OD_ORDER_DETL_ID
				,OODD.OD_ORDER_DETL_SEQ
				,OODD.OD_ORDER_DETL_DAILY_ID
				,OODD.OD_ORDER_ID
			FROM
				OD_ORDER_DETL_DAILY OODD INNER JOIN OD_ORDER_DETL_DAILY_SCH OODDS ON OODD.OD_ORDER_DETL_DAILY_ID = OODDS.OD_ORDER_DETL_DAILY_ID
			WHERE OODD.OD_ORDER_DETL_SEQ <![CDATA[>]]> 0 AND OODDS.USE_YN = 'Y'
				<choose>
					<when test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(odOrderId)">
						AND OODD.OD_ORDER_ID = #{odOrderId}
					</when>
					<otherwise>
						AND OODD.OD_ORDER_DETL_ID = #{odOrderDetlId}
					</otherwise>
				</choose>
			GROUP BY OODD.OD_ORDER_DETL_ID, OODDS.OD_SHIPPING_ZONE_ID
			) T1
			INNER JOIN OD_ORDER_DETL_DAILY_SCH T2 ON T1.OD_ORDER_DETL_DAILY_ID = T2.OD_ORDER_DETL_DAILY_ID AND T1.OD_SHIPPING_ZONE_ID = T2.OD_SHIPPING_ZONE_ID
		WHERE
			T1.OD_ORDER_DETL_SEQ <![CDATA[>]]> 0
			AND T2.USE_YN = 'Y'
			<choose>
				<when test="@kr.co.pulmuone.v1.comm.util.StringUtil@isNotEmpty(odOrderId)">
					AND T1.OD_ORDER_ID = #{odOrderId}
				</when>
				<otherwise>
					AND T1.OD_ORDER_DETL_ID = #{odOrderDetlId}
				</otherwise>
			</choose>
		GROUP BY T1.OD_ORDER_DETL_ID, T2.OD_SHIPPING_ZONE_ID
	</insert>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 주문상세 일일배송 스토어정보 수정
	 * @ 수정일			수정자		  수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.07.15		김명진	  		최초생성
	────────────────────────────────────────────────────────────────────────-->
	<update id="putOrderDetlDailyUrStoreId">
		/*	orderDetailSchedule.addOrderDetlDailyZoneByOdOrderDetlId  */
		UPDATE	OD_ORDER_DETL_DAILY
		SET 	UR_STORE_ID = (SELECT UR_STORE_ID FROM OD_SHIPPING_ZONE WHERE OD_SHIPPING_ZONE_ID = #{odShippingZoneId})
		WHERE	OD_ORDER_ID = #{odOrderId}
		<if test="odOrderDetlId != null and odOrderDetlId != 0">
		AND		OD_ORDER_DETL_ID = #{odOrderDetlId}
		</if>
	</update>

	<!--───────────────────────────────────────────────────────────────────────
	 * description 		: 녹즙 API 취소 전송 여부 수정
	 * @ 수정일			수정자		  수정내용
	 * @ ──────────────────────────────────────────────────────────────────────
	 * @ 2021.07.27		김명진	  		최초생성
	────────────────────────────────────────────────────────────────────────-->
	<update id="putOrderDetlScheduleApiCancelSendYn">
		/*	orderDetailSchedule.putOrderDetlScheduleApiCancelSendYn  */
		UPDATE	OD_ORDER_DETL_DAILY_SCH
		SET		API_CANCEL_SEND_YN = 'Y'
		WHERE	OD_ORDER_DETL_DAILY_SCH_ID IN
		<foreach item="data" index="index" collection="cancelGreenJuiceList" open="(" separator="," close=")">
			#{data.odOrderDetlDailySchId}
		</foreach>
	</update>
</mapper>