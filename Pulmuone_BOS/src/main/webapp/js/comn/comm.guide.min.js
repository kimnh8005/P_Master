var forbizMain;
var fnForbizMain = {
    init : function(){
        fnForbizMain.setTabStrip();
        fnForbizMain.setSortable();
        fnForbizMain.setCloseTab();
        fnForbizMain.resizing();
    },
    setTabStrip : function(){
        forbizMain = $("#forbizMain").kendoTabStrip({
            animation        : false,
            dataTextField    : "text",
            dataContentField : "content"
        }).data("kendoTabStrip");
        
    },
    setSortable : function () {
        $("#forbizMain ul.k-tabstrip-items").kendoSortable({
            filter: "li.k-item",
            axis: "x",
            container: "ul.k-tabstrip-items",
            hint: function (element) {
                return $("<div id='hint' class='k-widget k-header k-tabstrip'><ul class='k-tabstrip-items k-reset'><li class='k-item k-state-active k-tab-on-top'>" + element.html() + "</li></ul></div>");
            },
            start: function (e) {
                forbizMain.activateTab(e.item);
            },
            change: function (e) {
                var tabstrip = $("#forbizMain").data("kendoTabStrip"),
                    reference = tabstrip.tabGroup.children().eq(e.newIndex);

                if (e.oldIndex < e.newIndex) {
                    tabstrip.insertAfter(e.item, reference);
                } else {
                    tabstrip.insertBefore(e.item, reference);
                }
            }
        });
    },
    setCloseTab : function () {
        var tabsElements = $('#forbizMain li[role="tab"]');
        
        $.each(tabsElements, function(idx){
            if( $(this).find('span[name=forbizMain_tabstrip_item]').data('uid') != 'forbizMainUID' ){
                $(this).append('<span data-type="remove" class="k-link"><span class="k-icon k-font-icon k-i-x"></span></span>');
            }
        });

        forbizMain.tabGroup.on("click", "[data-type='remove']", function (e) {
            e.preventDefault();
            e.stopPropagation();

            var item = $(e.target).closest(".k-item");
            
            if( forbizMain.items().length == 2 ){
                forbizMain.select(0);
            }else{
                forbizMain.select(item.prev());
            }
            
            forbizMain.remove(item.index());

        });
    },
    openTab : function( opt ){
        var items = forbizMain.tabGroup.children("li");
        var uid = opt.uid;
        var newYn = 'Y';

        $.each(items, function(idx){
            if( $(this).find('span[name=forbizMain_tabstrip_item]').data('uid') == uid ){
                forbizMain.select($(this));
                newYn = 'N';
                return false;
            }
        });
        
        if(newYn == 'Y'){
            fnForbizMain.newTab(opt);
        }
        
    },
    newTab : function( opt ){
        
        fnOpenLoading( '', 2 );
        
        forbizMain.append({
            text: '<span name="forbizMain_tabstrip_item" data-uid="'+opt.uid+'" style="cursor:pointer;">'+opt.name+'</span>',
            encoded: false,
            content : '<div><iframe src="'+opt.url+'" width="100%" height="100%" scrolling="auto" visible="true" frameborder="0"></iframe></div>',
        });
        
        $('#forbizMain li[role="tab"]').last().append('<span data-type="remove" class="k-link"><span class="k-icon k-font-icon k-i-x"></span></span>');
        
        fnForbizMain.selectTab( opt );
        fnForbizMain.resizing( $('#forbizMain').children('.k-content').last() );
       
    },
    selectTab : function( opt ){
        var items = forbizMain.tabGroup.children("li");
        var uid = opt.uid;

        $.each(items, function(idx){
            if( $(this).find('span[name=forbizMain_tabstrip_item]').data('uid') == uid ){
                forbizMain.select($(this));
                return false;
            }
        });  
    },
    resizing : function( divs ){
        
        console.log( $(window).height() + ' // ' + $(document).height() + ' // ' + document.body.scrollHeight + ' // ' + document.body.offsetHeight + ' // ' + $("body").css("height") );
        //899 -> 819
        //$('#mainDiv').css( 'height', document.body.scrollHeight - 80 );
        $('#mainDiv').css( 'height', $(window).height() - 80 );
        // 775
        var tabstrip = $("#forbizMain").kendoTabStrip();
        
        tabstrip.parent().css( { 'height': '100%' } );
        
        var height = tabstrip.parent().height() - 40 - 26;
        
        tabstrip.children(".k-content").height( height );
        tabstrip.children(".k-content").find('iframe').height( height );
    },
    dummy : function(){}    
};

function fnMyMenuPopup(){
    fnKendoPopup({
        id     : 'MY_MENU_POP',
        title  : 'MY MENU',
        width  : '50%',
        height : '80%',
        src    : '/partials/myMenu.html',
        success: function( id, data ){
            if( data.SCRN_URL != null ){
                
                fnForbizMain.openTab({ 'uid'  : data.MENU_SEQ,
                                       'name' : data.MENU_NAME,
                                       'url'  : data.SCRN_URL });
            }
        }
    });
}

function fnInitialize(){
    fnForbizMain.init();

    $(window).resize(function(){
        fnForbizMain.resizing();
    });
    
    fnCustom();
    
}